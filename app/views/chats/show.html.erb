<div data-controller="modal-urgence" data-modal-urgence-response-value=<%= @chat.messages.where(role: "user").last.content %> data-modal-urgence-counter-value=<%= @chat.messages.where(role: "user").count%>>


  <div class="show-chat" >

    <div class="chat-container">

      <div class="header-chat">
        <%= link_to '<i class="ph-bold ph-arrow-left"></i>'.html_safe, home_path(lat: params[:lat], long: params[:long], city: params[:city], address: params[:address]), class: "btn btn-secondary" %>
        <h4>Quitter</h4>
      </div>

      <div class="the-chat">

        <% @chat.messages.each do |message| %>

          <div id="messages">
            <% if message.role == "user" %>
              <div class="user">
                <div class="message-user">
                <%= message.content %>
                </div>
              </div>

            <% elsif message.role == "assistant" %>
              <div class="assistant">
                <div class="logo">
                  <%= image_tag "logo.png" %>
                </div>
                <div class="message-assistant">
                  <%= message.content %>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>

          <%if @chat.messages.where(role: "user").count < 3  %>
            <div class= "btn-yes-or-no" data-modal-urgence-target="form">
              <%= simple_form_for [@chat, @message], html: { class: 'd-flex flex-grow-1' } do |f| %>
                <%= f.hidden_field :content, value: "oui" %>
                <%= hidden_field_tag :address, params[:address] %>
                <%= hidden_field_tag :city, params[:city] %>
                <%= hidden_field_tag :long, params[:long] %>
                <%= hidden_field_tag :lat, params[:lat] %>
                <%= f.button :submit, "OUI", class: "btn btn-success yes flex-grow-1" %>
              <% end %>

              <%= simple_form_for [@chat, @message], html: { class: 'd-flex flex-grow-1' } do |f| %>
                <%= f.hidden_field :content, value: "non" %>
                <%= hidden_field_tag :address, params[:address] %>
                <%= hidden_field_tag :city, params[:city] %>
                <%= hidden_field_tag :long, params[:long] %>
                <%= hidden_field_tag :lat, params[:lat] %>
                <%= f.button :submit, "NON", class: "btn btn-secondary no flex-grow-1"%>
              <% end %>
            </div>
          <% else %>


        <!-- Boutton Modal ouverture automatique -->
        <div class="buttons d-flex align-items-center justify-content-center" data-action="click->modal-urgence#openModal" data-modal-urgence-target="btn">
          <button id="myBtn-urgence" class="btn-diagnostic fw-500 btn btn-primary d-flex align-items-center justify-content-center flex-grow-1 gap-2">
            <i class="ph-bold ph-hospital"></i>
            Afficher les instructions
          </button>
          </div>

            <div id="myModal-urgence" data-modal-urgence-target="modal" class="modal">
              <div class="modal-content">
                <div class="modal-header d-flex justify-content-between">
                  <h4>Instructions</h4>
                  <span class="close" data-action="click->modal-urgence#closeModal">
                    <i class="ph-bold ph-x"></i>
                  </span>
                </div>
                <div class="modal-body">
                  <%= render partial: "modal_urgence", local: {chat: @chat, message: @message} %>
                </div>
              </div>
            </div>
        <% end %>

      </div>
    </div>

  <!-- Lien temporaire pour faire le tour de l'appli : -->
  <% @cases.each do |cas| %>
    <%= link_to case_path(cas.id, intervention_id: @intervention.id, lat: params[:lat], long: params[:long], city: params[:city], address: params[:address]),class: "btn-massage d-flex align-items-center justify-content-center gap-2" do %>
        <%= image_tag "emergency-2.png", alt: "Urgence", class: "btn-massage border-0" %>
        <p class="fw-600">Aide massage cardiaque</p>
    <% end %>
  <% end %>
  </div>
</div>
